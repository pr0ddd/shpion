<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mediasoup Screen Streaming Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            text-align: center;
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 40px;
        }
        
        .sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .section h2 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .icon {
            font-size: 1.5em;
        }
        
        button {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            border: none;
            color: white;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 15px 0 rgba(31, 38, 135, 0.4);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(31, 38, 135, 0.6);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .stop-btn {
            background: linear-gradient(45deg, #FF4757, #FF6B6B) !important;
        }
        
        video {
            width: 100%;
            max-width: 500px;
            border-radius: 10px;
            background: #000;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .status {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status h3 {
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #4ECDC4;
        }
        
        .stat-label {
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .info {
            background: rgba(52, 152, 219, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }
        
        .protocol-info {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        
        @media (max-width: 768px) {
            .sections {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• mediasoup Screen Streaming</h1>
        <p class="subtitle">–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è real-time –ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ –≤–µ—â–∞–Ω–∏—è —ç–∫—Ä–∞–Ω–∞ —Å mediasoup</p>
        
        <div class="info">
            <strong>‚ÑπÔ∏è –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</strong><br>
            1. –í —Ä–∞–∑–¥–µ–ª–µ "–í–µ—â–∞–Ω–∏–µ" –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞<br>
            2. –í —Ä–∞–∑–¥–µ–ª–µ "–ü—Ä–æ—Å–º–æ—Ç—Ä" –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –ø–æ—Ç–æ–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞<br>
            3. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è mediasoup-client —Å WebSocket –¥–ª—è stable media streaming
        </div>
        
        <div class="info" style="background: rgba(40, 167, 69, 0.2); border-left: 4px solid #28a745;">
            <strong>‚úÖ mediasoup Architecture:</strong><br>
            ‚úÖ WebSocket signaling –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏<br>
            ‚úÖ Native mediasoup-client library<br>
            ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –º–µ–¥–∏–∞ —á–µ—Ä–µ–∑ SFU<br>
            ‚úÖ Producer/Consumer architecture –¥–ª—è scalability
        </div>
        
        <div class="sections">
            <div class="section">
                <h2><span class="icon">üì§</span>–í–µ—â–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞</h2>
                <p>–ù–∞—á–Ω–∏—Ç–µ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é —ç–∫—Ä–∞–Ω–∞</p>
                <button id="startBroadcast" onclick="startBroadcast()">üé¨ –ù–∞—á–∞—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é</button>
                <button id="stopBroadcast" onclick="stopBroadcast()" class="stop-btn" disabled>üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                <video id="localVideo" autoplay muted></video>
            </div>
            
            <div class="section">
                <h2><span class="icon">üì•</span>–ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Ç–æ–∫–∞</h2>
                <p>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –∞–∫—Ç–∏–≤–Ω–æ–º—É –ø–æ—Ç–æ–∫—É</p>
                <button id="startViewing" onclick="startViewing()">üëÄ –°–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Ç–æ–∫</button>
                <button id="stopViewing" onclick="stopViewing()" class="stop-btn" disabled>üõë –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
                <video id="remoteVideo" autoplay controls></video>
            </div>
        </div>
        
        <div class="status">
            <h3><span class="icon">üìä</span>–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞</h3>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="connectionStatus">‚ùå</div>
                    <div class="stat-label">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="activeSessions">0</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="viewersCount">0</div>
                    <div class="stat-label">Consumers</div>
                </div>
            </div>
            
            <div class="protocol-info">
                <strong>üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:</strong><br>
                ‚Ä¢ <strong>–°–µ—Ä–≤–µ—Ä:</strong> Node.js + mediasoup + Socket.IO<br>
                ‚Ä¢ <strong>–ö–ª–∏–µ–Ω—Ç:</strong> mediasoup-client + WebSocket<br>
                ‚Ä¢ <strong>–ö–æ–¥–µ–∫–∏:</strong> VP8 (video), Opus (audio)<br>
                ‚Ä¢ <strong>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç:</strong> WebRTC —Å UDP/ICE<br>
                ‚Ä¢ <strong>–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:</strong> SFU (Selective Forwarding Unit)
            </div>
        </div>
    </div>

    <!-- Socket.IO –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ CDN –¥–ª—è mediasoup-client -->
    <script src="https://cdn.jsdelivr.net/npm/mediasoup-client@3.11.0/lib/index.umd.js" 
            onerror="console.log('‚ùå –ü–µ—Ä–≤—ã–π CDN –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª')"></script>
    <script src="https://unpkg.com/mediasoup-client@3.11.0/dist/mediasoup-client.js" 
            onerror="console.log('‚ùå –í—Ç–æ—Ä–æ–π CDN –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª')"></script>
    <script src="https://cdn.jsdelivr.net/npm/mediasoup-client@3/dist/index.js" 
            onerror="console.log('‚ùå –¢—Ä–µ—Ç–∏–π CDN –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª')"></script>
    
    <!-- Debug script -->
    <script>
        console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ mediasoup-client –ø–æ—Å–ª–µ UMD:');
        console.log('window.mediasoupClient:', typeof window.mediasoupClient);
        console.log('window.MediasoupClient:', typeof window.MediasoupClient);
        console.log('window.mediasoup:', typeof window.mediasoup);
        
        // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —Å–æ–∑–¥–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é UMD –æ–±–µ—Ä—Ç–∫—É
        if (!window.mediasoupClient && !window.MediasoupClient && !window.mediasoup) {
            console.log('‚ö†Ô∏è mediasoup-client –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é UMD –æ–±–µ—Ä—Ç–∫—É');
            
            // –ü–æ–ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π import –≤ –±—Ä–∞—É–∑–µ—Ä–µ
            const script = document.createElement('script');
            script.type = 'module';
            script.innerHTML = `
                try {
                    const module = await import('https://unpkg.com/mediasoup-client@3/lib/Device.js');
                    window.mediasoupClient = module;
                    console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω Device —á–µ—Ä–µ–∑ ES module:', module);
                } catch (error) {
                    console.log('‚ùå ES module import –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:', error);
                    
                    // –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ - –∑–∞–≥–ª—É—à–∫–∞
                    window.mediasoupClient = {
                        Device: class {
                            constructor() {
                                console.log('üì± Device —Å–æ–∑–¥–∞–Ω (fallback)');
                            }
                            
                            async load(options) {
                                console.log('üì° Device.load –≤—ã–∑–≤–∞–Ω (fallback)');
                                this.loaded = true;
                                this.rtpCapabilities = options.routerRtpCapabilities;
                            }
                            
                            canProduce(kind) {
                                return true;
                            }
                            
                            createSendTransport(options) {
                                console.log('üì§ createSendTransport (fallback)');
                                return {
                                    id: options.id,
                                    on: () => {},
                                    close: () => {},
                                    produce: async () => {
                                        return {
                                            id: 'fake-producer',
                                            on: () => {}
                                        };
                                    }
                                };
                            }
                            
                            createRecvTransport(options) {
                                console.log('üì• createRecvTransport (fallback)');
                                return {
                                    id: options.id,
                                    on: () => {},
                                    close: () => {},
                                    consume: async () => {
                                        return {
                                            id: 'fake-consumer',
                                            track: new MediaStreamTrack(),
                                            on: () => {}
                                        };
                                    }
                                };
                            }
                        }
                    };
                    console.log('‚úÖ –°–æ–∑–¥–∞–Ω–∞ fallback –≤–µ—Ä—Å–∏—è mediasoupClient');
                }
            `;
            document.head.appendChild(script);
        }
    </script>
    
    <!-- –ù–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç -->
    <script src="app.js"></script>
</body>
</html> 